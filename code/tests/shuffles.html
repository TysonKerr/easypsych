<!DOCTYPE html>
<html>
<head>
    <title>Shuffle Tests</title>
    <meta charset="utf-8">
    <base href="../..">
    <script src="code/vendor/seedrandom.3.0.5.min.js"></script>
    <script src="code/js/helper.js"></script>
    <script src="code/js/CSV.js"></script>
    <style>
        .shuffle-demo { text-align: center; }
        .csv-pair-container > div {
            width: 50%;
            display: inline-block;
            padding: 5px;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .csv-pair-container > div:first-child table { margin-left: auto; }
        
        table {
            text-align: left;
            border-collapse: collapse;
            font-family: monospace;
            overflow: auto;
            user-select: none;
        }
        td, th {
            border: 1px solid black;
        }
        td { padding: 0; }
        th { padding: 1px 4px; }
        
        td > span {
            display: block;
            padding: 1px 4px;
            white-space: nowrap;
            max-width: 150px;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        td > span:empty:after {
            content: "\a0";
        }
        
        #cell-color-input {
            display: none;
            position: fixed;
            top: 25px;
            left: 25px;
        }
        
        #cell-color-input.shown {
            display: initial;
        }
    </style>
    <style id="cell-styles"></style>
</head>
<body>

<div id="shuffle-demo-container"></div>

<input type="color" id="cell-color-input">

<script>
"use strict";

const csvs = [];
const selected_cell_classes = [];
const cell_class_lookup = {};

function make_csv(headers, ...rows) {
    const csv = [];
    
    for (let i = 0; i < rows.length; ++i) {
        const row = {};
        
        for (let j = 0; j < headers.length; ++j) {
            row[headers[j]] = (j in rows[i]) ? rows[i][j] : "";
        }
        
        csv.push(row);
    }
    
    return csv;
}

function clone_csv(csv) {
    const clone = [];
    
    for (let i = 0; i < csv.length; ++i) {
        let row = {};
        
        for (let col in csv[i]) {
            row[col] = csv[i][col].clone ? csv[i][col].clone() : csv[i][col];
        }
        
        clone.push(row);
    }
    
    return clone;
}

function get_csv_html(csv) {
    const cols = Object.keys(csv[0]).length,
          rows = csv.length;
    
    let html = `<table style='--cols: ${cols}; --rows: ${rows};'> <thead> <tr> <th>`
        + Object.keys(csv[0]).join("</th> <th>")
        + "</th> </tr> </thead> <tbody>";
    
    for (let i = 0; i < csv.length; ++i) {
        html += "<tr> <td>" + Object.values(csv[i]).map(cell => cell.get_wrapped_value()).join("</td> <td>") + "</td> </tr>";
    }
    
    html += "</tbody> </table>";
    return html;
}

function Cell(value, x, y, class_prefix) {
    this.value = value;
    this.x = x;
    this.y = y;
    this.class_prefix = class_prefix;
}

Cell.prototype = {
    toString: function() { return this.value; },
    get_wrapped_value: function() {
        return `<span class='shuffle-cell c-${this.class_prefix}-${this.x}-${this.y}'>`
                + this.value.replace(/&/g, "&amp;").replace(/</g, "&lt;")
                + "</span>";
    },
    clone: function() {
        return new Cell(this.value, this.x, this.y, this.class_prefix);
    }
};

function get_csv_clone_with_contents_wrapped(csv, csv_id) {
    const clone = clone_csv(csv);
    const headers = Object.keys(clone[0]);
    
    for (let y = 0; y < clone.length; ++y) {
        for (let x = 0; x < headers.length; ++x) {
            clone[y][headers[x]] = new Cell(clone[y][headers[x]], x, y, csv_id);
        }
    }
    
    return clone;
}

function display_csv_shuffle(csv) {
    const csv_index = csvs.length;
    const unshuffled_csv = get_csv_clone_with_contents_wrapped(csv, csv_index);
    csvs.push(unshuffled_csv);
    const shuffled_csv = clone_csv(unshuffled_csv);
    CSV.shuffle(shuffled_csv);
    const container = document.getElementById("shuffle-demo-container");
    
    container.insertAdjacentHTML("beforeend", 
        "<div class='shuffle-demo' data-csv='" + csv_index + "'>"
            + "<div class='csv-pair-container'><div>"
            + get_csv_html(unshuffled_csv)
            + "</div><div>"
            + get_csv_html(shuffled_csv)
            + "</div></div>"
            + "<div><button class='reshuffle-button'>Reshuffle</button></div>"
        + "</div>"
    );
}

function reshuffle_demo(demo_element) {
    const csv_index = demo_element.dataset.csv;
    const csv_shuffled = clone_csv(csvs[csv_index]);
    CSV.shuffle(csv_shuffled);
    const shuffled_container = demo_element.querySelector(".csv-pair-container > div:last-child");
    shuffled_container.innerHTML = get_csv_html(csv_shuffled);
}

function get_rgb_of_background_color(element) {
    // credit Danilo Valente @ https://stackoverflow.com/questions/11670019/does-object-style-color-only-return-rgb
    var rgb = getComputedStyle(element).backgroundColor.match(/\d+/g);
    
    if (rgb.length > 3) {
        if (rgb[3] === "0") {
            return "#ffffff";
        } else {
            rgb.splice(3, rgb.length - 3);
        }
    }
    
    return "#" + rgb.map(val => parseInt(val).toString(16).padStart(2, "0")).join("");
}

function show_color_input(clicked_element) {
    selected_cell_classes.splice(0, selected_cell_classes.length);
    selected_cell_classes.push(clicked_element.classList[1]);
    const color_input = document.getElementById("cell-color-input");
    const current_color = get_rgb_of_background_color(clicked_element);
    color_input.value = current_color === "#ffffff" ? "#00ff00" : current_color;
    color_input.classList.add("shown");
}

function hide_color_input() {
    selected_cell_classes.splice(0, selected_cell_classes.length);
    document.getElementById("cell-color-input").classList.remove("shown");
}

document.getElementById("shuffle-demo-container").addEventListener("click", function(event) {
    if (event.target.tagName === "BUTTON") {
        reshuffle_demo(event.target.closest(".shuffle-demo"));
    }
});

document.addEventListener("click", function(event) {
    if (event.target.classList.contains("shuffle-cell")) {
        show_color_input(event.target);
    } else if (event.target !== document.getElementById("cell-color-input")) {
        hide_color_input();
    }
});

document.getElementById("cell-color-input").addEventListener("input", function() {
    const sheet = document.getElementById("cell-styles").sheet;
    const rules = sheet.cssRules || sheet.rules;
    const color = this.value;
    
    selected_cell_classes.forEach(cell_class => {
        if (!(cell_class in cell_class_lookup)) {
            cell_class_lookup[cell_class] = rules.length;
            sheet.insertRule(`.${cell_class} { background-color: ${color}; }`, rules.length);
        } else {
            rules[cell_class_lookup[cell_class]].style.backgroundColor = color;
        }
    });
});

let csv = make_csv(
    ["Cue",      "Answer",    "Shuffle"],
    ["2",        "---",       ""],
    ["3",        "---",       "off"],
    ["1.1-",     "Apple",     "group a"],
    ["1.2--",    "Banana",    "group a"],
    ["1.3---",   "Cucumber",  "group a"],
    ["1.4----",  "Donut",     "group a"],
    ["1.5-----", "Enchilada", "group a"],
    ["2.1-",     "Flapjack",  "group b"],
    ["2.2--",    "Gelatin",   "group b"],
    ["2.3---",   "Hummus",    "group b"],
    ["2.4----",  "Ice cream", "group b"],
    ["2.5-----", "Juice",     "group b"],
);

display_csv_shuffle(csv);

</script>

</body>
</html>
